---
title: "Corvina Reina Gulf of Nicoya Zone 201 2012"
output:
  html_document:
    toc: true
    toc_depth: 2
---
##Setup

```{r setup, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(reshape)
library(ggplot2)
library(lubridate)
library(plotly)

```


```{r length_dist_2012}

corvina.all.2012.short<- read.csv('./data/corvina_length_monthly_2012.csv') 
corvina.all.2012.short$date = as.Date(corvina.all.2012.short$date, "%m/%d/%y")

corvina.all.2012 <- untable(corvina.all.2012.short[ , c(1,4)], num=corvina.all.2012.short[ ,5]) %>%
  mutate(label = month.abb[month(date)])

```

## Length Composition Corvina Reina 2012

```{r plot}

p1<- ggplot(corvina.all.2012, aes(length_class, fill=factor(label, levels =    unique(label)))) +
    geom_histogram(binwidth = 1) +
    theme_minimal()+
    guides(fill=guide_legend(title="Month"))
   
ggplotly(p1)

```
  
<spacer> 

## Age at length

This is two different approaches to convert lengths to age. The first is a formula I got from someone elses code. The second is the equation from [FAO](http://www.fao.org/docrep/w5449e/w5449e06.htm#4.4.5 the linearized catch curve based on length composition data):

$$t(L)=t_0 - 1/K * ln(1-L/L_{inf})$$


 ** the second seems better because we know that length/ age at maturity if 55 cm/5 years
```{r age_at_length}
#Model parameters fom Mug Villanueva (1994)
#Used the lower bound of the range

Linf = 122.1
to = -0.136
K = 0.121

#Equation from Dan's code
corvina.age1 <- log(1-(pmin(corvina.all.2012$length_class, Linf*.99))/(-K)) + to

#Equation from FAO 
#(http://www.fao.org/docrep/w5449e/w5449e06.htm#4.4.5 the linearized catch curve based on length composition data)

corvina.age2 <- to - (1/K) * log(1-corvina.all.2012$length_class/Linf)

corvina.all.2012$age_class1 = corvina.age1

corvina.all.2012$age_class2 = corvina.age2

```

```{r plot_length_age}
corvina.age.length <- unique(corvina.all.2012[,c('length_class','age_class2')]) %>%
  dplyr::arrange(length_class)


ggplot(data = corvina.age.length, aes(x=age_class2, y=length_class)) +
  geom_point() +
  theme_minimal()

```

## Time to next size class (D)
  
"In the present context D t is the time it takes for an average fish to grow from length L1 to length L2, so we obtain D t by subtracting the two inverse von Bertalanffy equations (Eq. 3.3.3.2) corresponding to L2 and L1 respectively and obtain:"
```{r calculating_D}
#Vector to label L1 - L2 
L1.L2 <-vector(length=length(corvina.age.length$length_class))

#Vector to identify if difference in length classes is greater than 1
delta <- vector(length=length(corvina.age.length$length_class))

#Vector of the time it takes to grow from L1 to L2
D <- vector(length=length(corvina.age.length$length_class))



for (i in 1:length(corvina.age.length$length_class)){
  
L1 <- corvina.age.length[i,1]

L2 <- corvina.age.length[(i+1),1]
  
L1.L2[i] <-paste(L1, L2, sep="-") 

delta[i] <- L2 - L1

D[i] <- corvina.age.length[(i+1),2] - corvina.age.length[i,2]

}

table <- data.frame(L1.L2, D, delta)

```

```{r show_D, fig.width=4}

library(DT)
datatable(table, options = list(
                            pageLength = 25, 
                            autoWidth = TRUE))

```

